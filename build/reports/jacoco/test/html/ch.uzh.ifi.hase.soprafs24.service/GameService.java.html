<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GameService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sopra-fs25-group-10-server</a> &gt; <a href="index.source.html" class="el_package">ch.uzh.ifi.hase.soprafs24.service</a> &gt; <span class="el_source">GameService.java</span></div><h1>GameService.java</h1><pre class="source lang-java linenums">package ch.uzh.ifi.hase.soprafs24.service;

import ch.uzh.ifi.hase.soprafs24.constant.Country;
import ch.uzh.ifi.hase.soprafs24.constant.GameAccessType;
import ch.uzh.ifi.hase.soprafs24.constant.GameHints;
import ch.uzh.ifi.hase.soprafs24.constant.GameMode;
import ch.uzh.ifi.hase.soprafs24.constant.GameRoleType;
import ch.uzh.ifi.hase.soprafs24.constant.GameStatus;
import ch.uzh.ifi.hase.soprafs24.constant.GuessResult;
import ch.uzh.ifi.hase.soprafs24.constant.PlayerStatus;
import ch.uzh.ifi.hase.soprafs24.constant.TeamStatus;
import ch.uzh.ifi.hase.soprafs24.constant.UserStatus;
import ch.uzh.ifi.hase.soprafs24.entity.CountryProgressEntry;
import ch.uzh.ifi.hase.soprafs24.entity.Game;
import ch.uzh.ifi.hase.soprafs24.entity.HintEntry;
import ch.uzh.ifi.hase.soprafs24.entity.Player;
import ch.uzh.ifi.hase.soprafs24.entity.Team;
import ch.uzh.ifi.hase.soprafs24.repository.GameRepository;
import ch.uzh.ifi.hase.soprafs24.repository.PlayerRepository;
import ch.uzh.ifi.hase.soprafs24.repository.TeamRepository;
import ch.uzh.ifi.hase.soprafs24.entity.User;
import ch.uzh.ifi.hase.soprafs24.repository.UserRepository;
import ch.uzh.ifi.hase.soprafs24.rest.dto.GameCreateResponseDTO;
import ch.uzh.ifi.hase.soprafs24.rest.dto.GameGetDTO;
import ch.uzh.ifi.hase.soprafs24.rest.dto.GamePostDTO;
import ch.uzh.ifi.hase.soprafs24.rest.dto.GameStartDTO;
import ch.uzh.ifi.hase.soprafs24.rest.dto.HintGetDTO;
import ch.uzh.ifi.hase.soprafs24.rest.dto.OneVsOneResultDTO;
import ch.uzh.ifi.hase.soprafs24.rest.dto.PlayerDTO;
import ch.uzh.ifi.hase.soprafs24.rest.dto.PlayerResultDTO;
import ch.uzh.ifi.hase.soprafs24.rest.dto.SoloResultDTO;
import ch.uzh.ifi.hase.soprafs24.rest.dto.TeamVsTeamResultDTO;
import ch.uzh.ifi.hase.soprafs24.rest.dto.UserGetDTO;
import ch.uzh.ifi.hase.soprafs24.rest.dto.UserHistoryDTO;
import ch.uzh.ifi.hase.soprafs24.rest.dto.GameGetDTO;
import ch.uzh.ifi.hase.soprafs24.rest.mapper.DTOMapper;
import ch.uzh.ifi.hase.soprafs24.service.UtilService;
import ch.uzh.ifi.hase.soprafs24.constant.Country;

import org.hibernate.query.criteria.internal.expression.function.AggregationFunction.MAX;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.http.HttpStatus;
import org.springframework.messaging.simp.SimpMessagingTemplate;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.server.ResponseStatusException;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.Comparator;
import java.util.EnumSet;
import java.util.HashMap;
import java.util.List;
import java.util.UUID;
import java.util.Map;
import java.util.Objects;
import java.util.Optional;
import java.util.Random;
import java.util.Timer;
import java.util.TimerTask;
import java.util.List;
import java.util.stream.Collectors;
import java.time.Duration;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;

/**
* User Service
* This class is the &quot;worker&quot; and responsible for all functionality related to
* the user
* (e.g., it creates, modifies, deletes, finds). The result will be passed back
* to the caller.
*/
@Service
@Transactional
public class GameService {
    
<span class="fc" id="L81">    private final Logger log = LoggerFactory.getLogger(GameService.class);</span>
    
    private final GameRepository gameRepository;
    private final UserRepository userRepository;
    private final PlayerRepository playerRepository;
    private final TeamRepository teamRepository;
<span class="fc" id="L87">    private final DTOMapper dtoMapper = DTOMapper.INSTANCE;</span>
    
    private static final String webSocketSlug = &quot;/topic/games/&quot;;
    
    private Map&lt;Country, List&lt;Map&lt;String, Object&gt;&gt;&gt; generatedHints;
    
    //timer
<span class="fc" id="L94">    private final Map&lt;Long, Timer&gt; runningTimers = new HashMap&lt;&gt;();</span>
    
    @Autowired
    private SimpMessagingTemplate messagingTemplate;
    
<span class="fc" id="L99">    UtilService utilService = new UtilService();</span>
    
    public GameService(
    @Qualifier(&quot;gameRepository&quot;) GameRepository gameRepository,
    @Qualifier(&quot;userRepository&quot;) UserRepository userRepository,
    @Qualifier(&quot;playerRepository&quot;) PlayerRepository playerRepository,
<span class="fc" id="L105">    @Qualifier(&quot;teamRepository&quot;) TeamRepository teamRepository) {</span>
<span class="fc" id="L106">        this.playerRepository = playerRepository;</span>
<span class="fc" id="L107">        this.gameRepository = gameRepository;</span>
<span class="fc" id="L108">        this.userRepository = userRepository;</span>
<span class="fc" id="L109">        this.teamRepository = teamRepository;</span>
<span class="fc" id="L110">    }</span>
    
    public List&lt;Game&gt; getAllGames() {
<span class="nc" id="L113">        return this.gameRepository.findAll();</span>
    }
    
    //checks
    public void checkIfOwnerExists(Long userId){
<span class="nc" id="L118">        User userwithUserId = userRepository.findByUserId(userId);</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">        if(userwithUserId == null){</span>
<span class="nc" id="L120">            throw new ResponseStatusException(HttpStatus.NOT_FOUND, &quot;Owner is not a user! Please register or login to create a game!&quot;);</span>
        }
<span class="nc" id="L122">    }</span>
    
    public void checkIfGameHaveSameOwner(Long ownerId) {
<span class="nc" id="L125">        Game existingGame = gameRepository.findByOwnerId(ownerId);</span>
<span class="nc bnc" id="L126" title="All 4 branches missed.">        if (existingGame != null &amp;&amp; !existingGame.getGameStatus().equals(GameStatus.FINISHED)) {</span>
<span class="nc" id="L127">            throw new IllegalStateException(&quot;User already has an active game session.&quot;);</span>
        }
<span class="nc" id="L129">    }</span>
    // public void checkIfGameNameExists(String gameName){
    //     Game gameWithSameName = gameRepository.findBygameName(gameName);
    //     if(gameWithSameName != null){
    //         throw new ResponseStatusException(HttpStatus.CONFLICT, &quot;GameName exists! Please try a new one!&quot;);
    //     }
    // }
    
    // Game Creation Service
    public GameCreateResponseDTO createGame(Game gameToCreate) {
<span class="nc bnc" id="L139" title="All 2 branches missed.">        if (gameToCreate.getModeType() == null) {</span>
<span class="nc" id="L140">            throw new IllegalArgumentException(&quot;Game mode must be specified.&quot;);</span>
        }
        
<span class="nc" id="L143">        log.debug(&quot;Game MaxPlayersNumber: {}&quot;, gameToCreate.getMaxPlayersNumber());</span>
<span class="nc" id="L144">        Integer maxPlayers = gameToCreate.getMaxPlayersNumber();</span>
        
<span class="nc bnc" id="L146" title="All 2 branches missed.">        if (gameToCreate.getModeType() == GameMode.SOLO) {</span>
<span class="nc bnc" id="L147" title="All 2 branches missed.">            if (maxPlayers == null) {</span>
<span class="nc" id="L148">                gameToCreate.setMaxPlayersNumber(1); </span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">            } else if (maxPlayers != 1) {</span>
<span class="nc" id="L150">                throw new IllegalArgumentException(&quot;For SOLO games, the number of players must be exactly 1.&quot;);</span>
            }
            
<span class="nc" id="L153">            return createSoloGame(gameToCreate);</span>
        } else {
<span class="nc" id="L155">            return createMultiplayerGame(gameToCreate);</span>
        }
    }
    
    //SOLO game creation
    private GameCreateResponseDTO createSoloGame(Game gameToCreate) {
        // Create Game Object for SOLO game
<span class="nc" id="L162">        Game gameCreated = new Game();</span>
<span class="nc" id="L163">        gameCreated.setModeType(gameToCreate.getModeType());</span>
<span class="nc" id="L164">        gameCreated.setGameName(gameToCreate.getGameName());</span>
<span class="nc" id="L165">        gameCreated.setTime(gameToCreate.getTime());</span>
<span class="nc" id="L166">        gameCreated.setMaxPlayersNumber(1);  // Only one player in SOLO mode</span>
<span class="nc" id="L167">        gameCreated.setCurrentPlayersNumber(1); // The first player is the owner</span>
<span class="nc" id="L168">        gameCreated.setMaxHints(GameHints.MAX_HINTS);</span>
<span class="nc" id="L169">        gameCreated.setAccessType(gameToCreate.getAccessType());</span>
<span class="nc" id="L170">        gameCreated.setGameStatus(GameStatus.WAITING);</span>
<span class="nc" id="L171">        gameCreated.setGameCreationDate(LocalDateTime.now());</span>
        // gameCreated.setScoreBoard(new HashMap&lt;&gt;());
        
        // Create the owner player (no teams for solo game)
<span class="nc" id="L175">        Long ownerId = gameToCreate.getOwnerId();</span>
        Player ownerPlayer;
<span class="nc bnc" id="L177" title="All 2 branches missed.">        if (ownerId != null) {</span>
<span class="nc" id="L178">            User ownerUser = userRepository.findByUserId(ownerId);</span>
<span class="nc" id="L179">            ownerPlayer = new Player(ownerUser, gameCreated);</span>
<span class="nc" id="L180">        } else {</span>
<span class="nc" id="L181">            ownerPlayer = new Player(null, gameCreated); // No user in solo mode</span>
        }
        
<span class="nc" id="L184">        ownerPlayer.setPlayerStatus(PlayerStatus.WAITING);</span>
<span class="nc" id="L185">        ownerPlayer.setToken(UUID.randomUUID().toString());</span>
<span class="nc" id="L186">        ownerPlayer.setRole(GameRoleType.OWNER);</span>
        
        // Save Game first
<span class="nc" id="L189">        gameCreated = gameRepository.save(gameCreated);</span>
<span class="nc" id="L190">        gameRepository.flush();</span>
        
        // Now that the game is saved, associate the player with the game
<span class="nc" id="L193">        ownerPlayer = playerRepository.save(ownerPlayer);</span>
<span class="nc" id="L194">        gameCreated.addPlayer(ownerPlayer);</span>
<span class="nc" id="L195">        gameCreated.setOwnerId(ownerId);</span>
        
        // Save the final game and player
<span class="nc" id="L198">        gameCreated = gameRepository.save(gameCreated);</span>
<span class="nc" id="L199">        gameRepository.flush();</span>
<span class="nc" id="L200">        playerRepository.flush();</span>
        
<span class="nc" id="L202">        log.debug(&quot;Created new SOLO Game: {}&quot;, gameCreated);</span>
<span class="nc" id="L203">        return dtoMapper.convertGameToGameCreateResponseDTO(gameCreated, ownerPlayer);</span>
    }
    
    private GameCreateResponseDTO createMultiplayerGame(Game gameToCreate) {
<span class="nc" id="L207">        Integer maxPlayers = gameToCreate.getMaxPlayersNumber();</span>
        
<span class="nc bnc" id="L209" title="All 2 branches missed.">        if (gameToCreate.getModeType() == GameMode.ONE_VS_ONE) {</span>
<span class="nc bnc" id="L210" title="All 4 branches missed.">            if (maxPlayers != null &amp;&amp; maxPlayers != 2) {</span>
<span class="nc" id="L211">                throw new IllegalArgumentException(&quot;For 1v1 games, the number of players must be exactly 2.&quot;);</span>
            } else {
<span class="nc" id="L213">                gameToCreate.setMaxPlayersNumber(2);  // Ensure 2 players for 1v1</span>
            }
        }
<span class="nc bnc" id="L216" title="All 2 branches missed.">        else if (gameToCreate.getModeType() == GameMode.TEAM_VS_TEAM) {</span>
<span class="nc bnc" id="L217" title="All 6 branches missed.">            if (maxPlayers == null || maxPlayers &lt;= 2 || maxPlayers % 2 != 0) {</span>
<span class="nc" id="L218">                throw new IllegalArgumentException(&quot;For TEAM_VS_TEAM, max players must be an even number of at least 2.&quot;);</span>
            }
        }
        
<span class="nc" id="L222">        Game gameCreated = new Game();</span>
<span class="nc" id="L223">        gameCreated.setModeType(gameToCreate.getModeType());</span>
<span class="nc" id="L224">        gameCreated.setGameName(gameToCreate.getGameName());</span>
<span class="nc" id="L225">        gameCreated.setTime(gameToCreate.getTime());</span>
<span class="nc" id="L226">        gameCreated.setMaxPlayersNumber(gameToCreate.getMaxPlayersNumber());</span>
<span class="nc" id="L227">        gameCreated.setCurrentPlayersNumber(1); </span>
<span class="nc" id="L228">        gameCreated.setMaxHints(GameHints.MAX_HINTS);</span>
<span class="nc" id="L229">        gameCreated.setAccessType(gameToCreate.getAccessType());</span>
<span class="nc" id="L230">        gameCreated.setGameStatus(GameStatus.WAITING);</span>
<span class="nc" id="L231">        gameCreated.setGameCreationDate(LocalDateTime.now());</span>
        // gameCreated.setScoreBoard(new HashMap&lt;&gt;());
        
<span class="nc" id="L234">        Long ownerId = gameToCreate.getOwnerId();</span>
<span class="nc bnc" id="L235" title="All 2 branches missed.">        if (ownerId == null) {</span>
<span class="nc" id="L236">            throw new IllegalArgumentException(&quot;Owner ID must be provided for non-SOLO games.&quot;);</span>
        }
<span class="nc" id="L238">        checkIfOwnerExists(ownerId);</span>
<span class="nc" id="L239">        checkIfGameHaveSameOwner(ownerId);</span>
        
<span class="nc" id="L241">        gameCreated = gameRepository.save(gameCreated);</span>
<span class="nc" id="L242">        gameRepository.flush();  // Ensure the game is saved before saving players</span>
        
<span class="nc" id="L244">        List&lt;Team&gt; createdTeams = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L245" title="All 2 branches missed.">        if (gameToCreate.getModeType() == GameMode.TEAM_VS_TEAM) {</span>
<span class="nc" id="L246">            int totalPlayers = gameToCreate.getMaxPlayersNumber();</span>
<span class="nc" id="L247">            int desiredTeamSize = totalPlayers / 2;</span>
            
<span class="nc bnc" id="L249" title="All 2 branches missed.">            for (int i = 0; i &lt; 2; i++) {</span>
<span class="nc" id="L250">                Team team = new Team();</span>
<span class="nc" id="L251">                team.setGame(gameCreated);</span>
<span class="nc" id="L252">                team.setDesiredTeamSize(desiredTeamSize);</span>
<span class="nc" id="L253">                team.setTeamStatus(TeamStatus.WAITING);</span>
<span class="nc" id="L254">                teamRepository.save(team);</span>
<span class="nc" id="L255">                createdTeams.add(team);</span>
            }
<span class="nc" id="L257">            teamRepository.flush(); // Ensure teamIds are generated</span>
        }
        
<span class="nc" id="L260">        User ownerUser = userRepository.findByUserId(ownerId);</span>
<span class="nc" id="L261">        Player ownerPlayer = new Player(ownerUser, gameCreated);</span>
<span class="nc" id="L262">        ownerPlayer.setPlayerStatus(PlayerStatus.WAITING);</span>
<span class="nc" id="L263">        ownerPlayer.setToken(UUID.randomUUID().toString());</span>
<span class="nc" id="L264">        ownerPlayer.setRole(GameRoleType.OWNER);</span>
        
<span class="nc bnc" id="L266" title="All 4 branches missed.">        if (gameToCreate.getModeType() == GameMode.TEAM_VS_TEAM &amp;&amp; !createdTeams.isEmpty()) {</span>
<span class="nc" id="L267">            Team firstTeam = createdTeams.get(0);</span>
<span class="nc" id="L268">            ownerPlayer.setTeam(firstTeam);</span>
<span class="nc" id="L269">            firstTeam.addPlayer(ownerPlayer);</span>
        }
        
<span class="nc" id="L272">        ownerPlayer = playerRepository.save(ownerPlayer); </span>
<span class="nc" id="L273">        gameCreated.addPlayer(ownerPlayer); </span>
<span class="nc" id="L274">        gameCreated.setOwnerId(ownerId);</span>
        
<span class="nc bnc" id="L276" title="All 2 branches missed.">        if (gameToCreate.getAccessType() == GameAccessType.PRIVATE) {</span>
<span class="nc" id="L277">            gameCreated.setPassword(gameToCreate.getPassword());</span>
        }
        
<span class="nc" id="L280">        gameCreated = gameRepository.save(gameCreated);</span>
<span class="nc" id="L281">        gameRepository.flush();</span>
<span class="nc" id="L282">        playerRepository.flush();</span>
        
<span class="nc" id="L284">        log.debug(&quot;Created new Multiplayer Game: {}&quot;, gameCreated);</span>
<span class="nc" id="L285">        return dtoMapper.convertGameToGameCreateResponseDTO(gameCreated, ownerPlayer);</span>
    }
    
    public Game getGameByGameId(Long gameId){
<span class="nc" id="L289">        return gameRepository.findBygameId(gameId);</span>
    }
    
    public List&lt;PlayerDTO&gt; getUserHistory(Long userId) {
<span class="nc" id="L293">        User user = userRepository.findByUserId(userId);</span>
<span class="nc bnc" id="L294" title="All 2 branches missed.">        if (user == null) {</span>
<span class="nc" id="L295">            throw new ResponseStatusException(HttpStatus.NOT_FOUND, &quot;User not found&quot;);</span>
        }
        
<span class="nc" id="L298">        List&lt;Player&gt; players = playerRepository.findByUser_UserId(userId);</span>
<span class="nc" id="L299">        List&lt;PlayerDTO&gt; playerDTOs = new ArrayList&lt;&gt;();</span>
        
<span class="nc bnc" id="L301" title="All 2 branches missed.">        for (Player player : players) {</span>
<span class="nc" id="L302">            Game game = player.getGame();</span>
            
<span class="nc bnc" id="L304" title="All 4 branches missed.">            if (game != null &amp;&amp; game.getGameStatus() == GameStatus.FINISHED) {</span>
<span class="nc" id="L305">                PlayerDTO playerDTO = dtoMapper.convertPlayerToPlayerDTO(player);</span>
<span class="nc" id="L306">                playerDTO.setGameId(game.getGameId());</span>
<span class="nc" id="L307">                playerDTO.setGameStatus(player.getGame().getGameStatus());</span>
<span class="nc" id="L308">                playerDTO.setScore(player.getScore());</span>
<span class="nc" id="L309">                playerDTO.setPlayerStatus(player.getPlayerStatus());</span>
<span class="nc bnc" id="L310" title="All 2 branches missed.">                playerDTO.setTeamId(player.getTeam() != null ? player.getTeam().getTeamId() : null);</span>
<span class="nc bnc" id="L311" title="All 2 branches missed.">                playerDTO.setTeamName(player.getTeam() != null ? player.getTeam().getTeamName() : null);</span>
<span class="nc" id="L312">                playerDTOs.add(playerDTO);</span>
            }
<span class="nc" id="L314">        }</span>
        
<span class="nc" id="L316">        return playerDTOs;</span>
    }
    
    public Player userJoinGame(Long gameId, Long userId, String password) {
<span class="nc" id="L320">        Game targetGame = gameRepository.findBygameId(gameId);</span>
        
<span class="nc bnc" id="L322" title="All 2 branches missed.">        if (targetGame == null) {</span>
<span class="nc" id="L323">            throw new ResponseStatusException(HttpStatus.NOT_FOUND, &quot;Game not found.&quot;);</span>
        }
        
        
<span class="nc bnc" id="L327" title="All 2 branches missed.">        if (targetGame.getModeType() == GameMode.SOLO) {</span>
<span class="nc" id="L328">            throw new ResponseStatusException(HttpStatus.BAD_REQUEST, &quot;You can't join a solo game!&quot;);</span>
        }
        
<span class="nc bnc" id="L331" title="All 2 branches missed.">        if (targetGame.getGameStatus() != GameStatus.WAITING) {</span>
<span class="nc" id="L332">            throw new ResponseStatusException(HttpStatus.BAD_REQUEST, &quot;You can't join this game because it is already started or finished!&quot;);</span>
        }
        
        // Check if the game is already full
<span class="nc bnc" id="L336" title="All 2 branches missed.">        if (targetGame.getCurrentPlayersNumber() &gt;= targetGame.getMaxPlayersNumber()) {</span>
<span class="nc" id="L337">            throw new ResponseStatusException(HttpStatus.BAD_REQUEST, &quot;You can't join this game because it is full!&quot;);</span>
        }
        
        // Check password if game is private
<span class="nc bnc" id="L341" title="All 2 branches missed.">        if (targetGame.getAccessType() == GameAccessType.PRIVATE) {</span>
<span class="nc bnc" id="L342" title="All 2 branches missed.">            if (!Objects.equals(password, targetGame.getPassword())) {</span>
<span class="nc" id="L343">                throw new ResponseStatusException(HttpStatus.UNAUTHORIZED, &quot;Wrong password! You can't join the game!&quot;);</span>
            }
        }
        
<span class="nc bnc" id="L347" title="All 2 branches missed.">        if (userId != null) {</span>
<span class="nc" id="L348">            List&lt;Player&gt; existingPlayers = playerRepository.findByGame_GameIdAndUser_UserId(gameId, userId);</span>
<span class="nc bnc" id="L349" title="All 6 branches missed.">            if (existingPlayers != null &amp;&amp; existingPlayers.stream().anyMatch(player -&gt; player.getPlayerStatus() == PlayerStatus.WAITING)) {</span>
<span class="nc" id="L350">                throw new ResponseStatusException(HttpStatus.BAD_REQUEST, &quot;User is already in the game.&quot;);</span>
            }
        }
        
        Player newPlayer;
        
<span class="nc bnc" id="L356" title="All 2 branches missed.">        if (userId != null) {</span>
<span class="nc" id="L357">            User user = userRepository.findByUserId(userId);</span>
<span class="nc bnc" id="L358" title="All 2 branches missed.">            if (user == null) {</span>
<span class="nc" id="L359">                throw new ResponseStatusException(HttpStatus.NOT_FOUND, &quot;User not found.&quot;);</span>
            }
            
<span class="nc" id="L362">            newPlayer = new Player(user, targetGame);</span>
<span class="nc" id="L363">            newPlayer.setPlayerStatus(PlayerStatus.WAITING);</span>
<span class="nc" id="L364">            newPlayer.setToken(UUID.randomUUID().toString());</span>
            
<span class="nc" id="L366">            newPlayer = playerRepository.save(newPlayer);</span>
<span class="nc" id="L367">            playerRepository.flush();</span>
            
<span class="nc bnc" id="L369" title="All 2 branches missed.">            if (targetGame.getOwnerId() == null) {</span>
<span class="nc" id="L370">                targetGame.setOwnerId(userId);</span>
            }
<span class="nc" id="L372">        } else {</span>
<span class="nc" id="L373">            newPlayer = new Player(null, targetGame);</span>
<span class="nc" id="L374">            newPlayer.setPlayerStatus(PlayerStatus.WAITING);</span>
<span class="nc" id="L375">            newPlayer.setToken(UUID.randomUUID().toString());</span>
<span class="nc" id="L376">            playerRepository.save(newPlayer);</span>
        }
        
        //TEAM VS TEAM - Assign player to a team randomly
<span class="nc bnc" id="L380" title="All 2 branches missed.">        if (targetGame.getModeType() == GameMode.TEAM_VS_TEAM) {</span>
<span class="nc" id="L381">            List&lt;Team&gt; teams = teamRepository.findByGame_GameId(targetGame.getGameId());</span>
            
<span class="nc bnc" id="L383" title="All 2 branches missed.">            if (teams.size() &lt; 2) {</span>
<span class="nc" id="L384">                throw new ResponseStatusException(HttpStatus.INTERNAL_SERVER_ERROR, &quot;Team setup is incorrect for team vs team game.&quot;);</span>
            }
            
<span class="nc" id="L387">            Team team1 = teams.get(0);</span>
<span class="nc" id="L388">            Team team2 = teams.get(1);</span>
            
<span class="nc" id="L390">            long count1 = team1.getTeamSize();</span>
<span class="nc" id="L391">            long count2 = team2.getTeamSize();</span>
            
<span class="nc bnc" id="L393" title="All 4 branches missed.">            if (count1 &gt;= team1.getDesiredTeamSize() &amp;&amp; count2 &gt;= team2.getDesiredTeamSize()) {</span>
<span class="nc" id="L394">                throw new ResponseStatusException(HttpStatus.BAD_REQUEST, &quot;Both teams are full!&quot;);</span>
            }
            
            Team selectedTeam;
<span class="nc bnc" id="L398" title="All 4 branches missed.">            if (count1 &lt; team1.getDesiredTeamSize() &amp;&amp; count2 &lt; team2.getDesiredTeamSize()) {</span>
<span class="nc bnc" id="L399" title="All 2 branches missed.">                selectedTeam = new Random().nextBoolean() ? team1 : team2;</span>
<span class="nc bnc" id="L400" title="All 2 branches missed.">            } else if (count1 &lt; team1.getDesiredTeamSize()) {</span>
<span class="nc" id="L401">                selectedTeam = team1;</span>
            } else {
<span class="nc" id="L403">                selectedTeam = team2;</span>
            }
            
<span class="nc" id="L406">            newPlayer.setTeam(selectedTeam);</span>
<span class="nc" id="L407">            selectedTeam.addPlayer(newPlayer);</span>
<span class="nc" id="L408">            teamRepository.save(selectedTeam);</span>
        }
        
<span class="nc" id="L411">        targetGame.addPlayer(newPlayer);</span>
<span class="nc" id="L412">        targetGame.setCurrentPlayersNumber(targetGame.getCurrentPlayersNumber() + 1);</span>
        
<span class="nc" id="L414">        gameRepository.save(targetGame);</span>
<span class="nc" id="L415">        gameRepository.flush();</span>
<span class="nc" id="L416">        playerRepository.flush();</span>
        
<span class="nc" id="L418">        List&lt;Player&gt; players = playerRepository.findByGame_GameId(targetGame.getGameId());</span>
<span class="nc" id="L419">        List&lt;PlayerDTO&gt; playerDTOs = players.stream()</span>
<span class="nc" id="L420">        .map(player -&gt; dtoMapper.convertPlayerToPlayerDTO(player))</span>
<span class="nc" id="L421">        .collect(Collectors.toList());</span>
        
<span class="nc" id="L423">        messagingTemplate.convertAndSend(&quot;/topic/ready/&quot; + targetGame.getGameId() + &quot;/players&quot;, playerDTOs);</span>
        
<span class="nc" id="L425">        log.info(&quot;Player {} joined game {}&quot;, newPlayer.getPlayerId(), targetGame.getGameId());</span>
        
<span class="nc bnc" id="L427" title="All 2 branches missed.">        if (targetGame.getCurrentPlayersNumber() == targetGame.getMaxPlayersNumber()) {</span>
<span class="nc" id="L428">            messagingTemplate.convertAndSend(&quot;/topic/ready/&quot; + targetGame.getGameId() + &quot;/status&quot;,</span>
            &quot;Players full! Let's play!&quot;);
<span class="nc" id="L430">            log.info(&quot;Game {} is full. Ready to play!&quot;, targetGame.getGameId());</span>
        }
        
<span class="nc" id="L433">        log.info(&quot;Player {} joined game {}&quot;, newPlayer.getPlayerId(), targetGame.getGameId());</span>
<span class="nc" id="L434">        return newPlayer;</span>
        
    }
    
    public void playerExitGame(Long playerId) {
<span class="nc" id="L439">        Player exitingPlayer = playerRepository.findByPlayerId(playerId);</span>
<span class="nc bnc" id="L440" title="All 2 branches missed.">        if(exitingPlayer == null) {</span>
<span class="nc" id="L441">            throw new ResponseStatusException(HttpStatus.NOT_FOUND, &quot;Player not found.&quot;);</span>
        }
        
<span class="nc bnc" id="L444" title="All 2 branches missed.">        if (exitingPlayer.getPlayerStatus() != PlayerStatus.PLAYING) {</span>
<span class="nc" id="L445">            throw new ResponseStatusException(HttpStatus.FORBIDDEN, &quot;Player cannot exit a game he is not playing.&quot;);</span>
        }
<span class="nc bnc" id="L447" title="All 2 branches missed.">        if (exitingPlayer.getGame() == null) {</span>
<span class="nc" id="L448">            throw new ResponseStatusException(HttpStatus.NOT_FOUND, &quot;Player is not in any game.&quot;);</span>
        }
<span class="nc" id="L450">        Game targetGame = exitingPlayer.getGame();</span>
        
<span class="nc bnc" id="L452" title="All 2 branches missed.">        if (targetGame == null) {</span>
<span class="nc" id="L453">            log.warn(&quot;Player not associated with any game.&quot;);</span>
<span class="nc" id="L454">            return;</span>
        }
        
<span class="nc bnc" id="L457" title="All 2 branches missed.">        boolean isOwner = exitingPlayer.getUser() != null &amp;&amp;</span>
<span class="nc bnc" id="L458" title="All 2 branches missed.">        exitingPlayer.getUser().getUserId().equals(targetGame.getOwnerId());</span>
        
<span class="nc" id="L460">        targetGame.removePlayer(exitingPlayer);</span>
<span class="nc" id="L461">        targetGame.setCurrentPlayersNumber(targetGame.getCurrentPlayersNumber() - 1);</span>
        
<span class="nc" id="L463">        playerRepository.delete(exitingPlayer);</span>
<span class="nc" id="L464">        playerRepository.flush();</span>
        
<span class="nc bnc" id="L466" title="All 2 branches missed.">        if (targetGame.getPlayers().isEmpty()) {</span>
<span class="nc" id="L467">            gameRepository.delete(targetGame);</span>
<span class="nc" id="L468">            gameRepository.flush();</span>
<span class="nc" id="L469">            log.info(&quot;Game deleted due to no players remaining.&quot;);</span>
<span class="nc" id="L470">            return;</span>
        }
        
<span class="nc bnc" id="L473" title="All 2 branches missed.">        if (isOwner) {</span>
<span class="nc" id="L474">            Optional&lt;Player&gt; newOwner = targetGame.getPlayers().stream()</span>
<span class="nc bnc" id="L475" title="All 4 branches missed.">            .filter(p -&gt; p.getUser() != null &amp;&amp; p.getUser().getUserId() != null)</span>
<span class="nc" id="L476">            .findFirst();</span>
            
<span class="nc bnc" id="L478" title="All 2 branches missed.">            if (newOwner.isPresent()) {</span>
<span class="nc" id="L479">                targetGame.setOwnerId(newOwner.get().getUser().getUserId());</span>
<span class="nc" id="L480">                log.info(&quot;Ownership transferred to player with userId {}&quot;, newOwner.get().getUser().getUserId());</span>
            } else {
<span class="nc" id="L482">                gameRepository.delete(targetGame);</span>
<span class="nc" id="L483">                gameRepository.flush();</span>
<span class="nc" id="L484">                log.info(&quot;Game deleted due to no eligible owner.&quot;);</span>
<span class="nc" id="L485">                return;</span>
            }
        }
        
<span class="nc" id="L489">        gameRepository.save(targetGame);</span>
<span class="nc" id="L490">        gameRepository.flush();</span>
        
        // Notify all players via WebSocket
<span class="nc" id="L493">        List&lt;Player&gt; players = playerRepository.findByGame_GameId(targetGame.getGameId());</span>
<span class="nc" id="L494">        List&lt;PlayerDTO&gt; playerDTOs = players.stream()</span>
<span class="nc" id="L495">        .map(player -&gt; dtoMapper.convertPlayerToPlayerDTO(player))</span>
<span class="nc" id="L496">        .collect(Collectors.toList());</span>
<span class="nc" id="L497">        messagingTemplate.convertAndSend(&quot;/topic/ready/&quot; + targetGame.getGameId() + &quot;/players&quot;, playerDTOs);</span>
<span class="nc" id="L498">        log.info(&quot;A Player exited and was deleted. WebSocket update sent.&quot;);</span>
<span class="nc" id="L499">    }</span>
    
    public void startGame(Long gameId, GameStartDTO playerDTO) {
<span class="nc" id="L502">        Game gameToStart = gameRepository.findBygameId(gameId);</span>
        
<span class="nc bnc" id="L504" title="All 2 branches missed.">        if (gameToStart == null) {</span>
<span class="nc" id="L505">            throw new ResponseStatusException(HttpStatus.NOT_FOUND, &quot;Game not found.&quot;);</span>
        }
        
<span class="nc bnc" id="L508" title="All 2 branches missed.">        if (gameToStart.getMaxPlayersNumber() != gameToStart.getCurrentPlayersNumber()) {</span>
<span class="nc" id="L509">            throw new ResponseStatusException(HttpStatus.FORBIDDEN, &quot;Game is not full yet.&quot;);</span>
        }
        
<span class="nc bnc" id="L512" title="All 2 branches missed.">        if (gameToStart.getGameStatus() != GameStatus.WAITING) {</span>
<span class="nc" id="L513">            throw new ResponseStatusException(HttpStatus.FORBIDDEN, &quot;Game is not in a state to be started.&quot;);</span>
        }
        
<span class="nc" id="L516">        Player player = playerRepository.findById(playerDTO.getPlayerId())</span>
<span class="nc" id="L517">        .orElseThrow(() -&gt; new ResponseStatusException(HttpStatus.NOT_FOUND, &quot;Player not found&quot;));</span>
        
<span class="nc bnc" id="L519" title="All 2 branches missed.">        if (!player.getGame().getGameId().equals(gameId)) {</span>
<span class="nc" id="L520">            throw new ResponseStatusException(HttpStatus.FORBIDDEN, &quot;Player does not belong to this game.&quot;);</span>
        }
        
<span class="nc bnc" id="L523" title="All 2 branches missed.">        if (!player.getRole().equals(GameRoleType.OWNER)) {</span>
<span class="nc" id="L524">            throw new ResponseStatusException(HttpStatus.FORBIDDEN, &quot;Player is not the owner of the game.&quot;);</span>
        }
        
<span class="nc bnc" id="L527" title="All 2 branches missed.">        if (!playerDTO.getToken().equals(player.getToken())) {</span>
<span class="nc" id="L528">            throw new ResponseStatusException(HttpStatus.FORBIDDEN, &quot;Invalid token.&quot;);</span>
        }
        
<span class="nc" id="L531">        gameToStart.setGameStatus(GameStatus.ACTIVE);</span>
<span class="nc" id="L532">        LocalDateTime startTime = LocalDateTime.now();</span>
<span class="nc" id="L533">        gameToStart.setStartTime(startTime);</span>
        
<span class="nc" id="L535">        LocalDateTime endTime = startTime.plusSeconds(gameToStart.getTime() + 1);</span>
<span class="nc" id="L536">        gameToStart.setEndTime(endTime);</span>
        
        
<span class="nc" id="L539">        generatedHints = waitForHintGeneration();</span>
<span class="nc" id="L540">        gameToStart = saveHintsAndAnswersToGame(gameToStart, generatedHints);     </span>
        
<span class="nc" id="L542">        setGameStartingScore(gameId);</span>
        
<span class="nc" id="L544">        gameRepository.save(gameToStart);</span>
<span class="nc" id="L545">        startGameTimer(gameToStart);</span>
<span class="nc" id="L546">        gameRepository.flush();</span>
        
<span class="nc" id="L548">        messagingTemplate.convertAndSend(&quot;/topic/start/&quot; + gameId + &quot;/scoreboard&quot;, getScoreBoard(gameId));</span>
        
<span class="nc" id="L550">    }</span>
    
    private void setGameStartingScore(Long gameId) {
<span class="nc" id="L553">        List&lt;Player&gt; players = playerRepository.findByGame_GameId(gameId);</span>
        
<span class="nc bnc" id="L555" title="All 2 branches missed.">        for (Player player : players) {</span>
<span class="nc" id="L556">            player.setPlayerStatus(PlayerStatus.PLAYING);</span>
<span class="nc" id="L557">            player.setCurrentHint(0);       </span>
<span class="nc" id="L558">            player.setHintsLeft(GameHints.MAX_HINTS);</span>
<span class="nc" id="L559">            player.setTriesLeft(10);</span>
            
<span class="nc" id="L561">            player.setQuestionId(Objects.requireNonNullElse(player.getQuestionId(), 0L) + 1);</span>
<span class="nc" id="L562">            player.setTotalQuestions(Objects.requireNonNullElse(player.getTotalQuestions(), 0L) + 1);</span>
<span class="nc" id="L563">            player.setScore(Objects.requireNonNullElse(player.getScore(), 0) + 100); // If no score, initialize it to 100, else increment score by 100</span>
            
<span class="nc bnc" id="L565" title="All 2 branches missed.">            if (player.getCorrectQuestions() == null) {</span>
<span class="nc" id="L566">                player.setCorrectQuestions(0L);</span>
            }
<span class="nc" id="L568">            playerRepository.save(player);</span>
<span class="nc" id="L569">        }</span>
        
<span class="nc" id="L571">        System.out.println(&quot;Scores updated for all players in game &quot;);</span>
<span class="nc" id="L572">        messagingTemplate.convertAndSend(&quot;/topic/start/&quot; + gameId + &quot;/scoreboard&quot;, getScoreBoard(gameId));</span>
        
<span class="nc" id="L574">    }</span>
    
    private void setQuestionStartingScore(Long playerId) {
<span class="nc" id="L577">        Player player = playerRepository.findById(playerId)</span>
<span class="nc" id="L578">        .orElseThrow(() -&gt; new ResponseStatusException(HttpStatus.NOT_FOUND, &quot;Player not found&quot;));</span>
<span class="nc" id="L579">        player.setCurrentHint(0); </span>
<span class="nc" id="L580">        player.setHintsLeft(GameHints.MAX_HINTS); </span>
<span class="nc" id="L581">        player.setTriesLeft(10); </span>
<span class="nc" id="L582">        player.setQuestionId(Objects.requireNonNullElse(player.getQuestionId(), 0L) + 1);</span>
<span class="nc" id="L583">        player.setTotalQuestions(Objects.requireNonNullElse(player.getTotalQuestions(), 0L) + 1);</span>
        
<span class="nc" id="L585">        player.setScore(Objects.requireNonNullElse(player.getScore(), 0) + 100); </span>
<span class="nc" id="L586">        playerRepository.save(player);</span>
        
<span class="nc" id="L588">        Long gameId = player.getGame().getGameId();</span>
<span class="nc" id="L589">        System.out.println(&quot;Player &quot; + playerId + &quot; score and progress updated.&quot;);</span>
<span class="nc" id="L590">        messagingTemplate.convertAndSend(&quot;/topic/start/&quot; + gameId + &quot;/scoreboard&quot;, getScoreBoard(gameId));</span>
<span class="nc" id="L591">    }</span>
    
    private Map&lt;Country, List&lt;Map&lt;String, Object&gt;&gt;&gt; waitForHintGeneration() {
<span class="nc" id="L594">        Map&lt;Country, List&lt;Map&lt;String, Object&gt;&gt;&gt; generatedHints = null;</span>
<span class="nc" id="L595">        boolean hintsGenerated = false;</span>
<span class="nc" id="L596">        int retryCount = 0;</span>
        
<span class="nc bnc" id="L598" title="All 4 branches missed.">        while (!hintsGenerated &amp;&amp; retryCount &lt; 3) {</span>
            try {
<span class="nc" id="L600">                generatedHints = getHintsOfOneCountry();</span>
<span class="nc" id="L601">                hintsGenerated = true;</span>
<span class="nc" id="L602">            } catch (Exception e) {</span>
<span class="nc" id="L603">                retryCount++;</span>
<span class="nc" id="L604">                System.err.println(&quot;Error generating hints, retrying... Attempt: &quot; + retryCount);</span>
                
<span class="nc bnc" id="L606" title="All 2 branches missed.">                if (retryCount &lt; 3) {</span>
                    try {
<span class="nc" id="L608">                        Thread.sleep(3000);</span>
<span class="nc" id="L609">                    } catch (InterruptedException interruptedException) {</span>
<span class="nc" id="L610">                        Thread.currentThread().interrupt();</span>
<span class="nc" id="L611">                    }</span>
                } else {
<span class="nc" id="L613">                    throw new ResponseStatusException(HttpStatus.INTERNAL_SERVER_ERROR, &quot;Failed to generate hints after several retries.&quot;);</span>
                }
<span class="nc" id="L615">            }</span>
        }
<span class="nc" id="L617">        return generatedHints;</span>
    }
    
    private void startGameTimer(Game game) {
<span class="nc" id="L621">        Timer timer = new Timer(true);</span>
<span class="nc" id="L622">        Long gameId = game.getGameId();</span>
        
<span class="nc" id="L624">        TimerTask task = new TimerTask() {</span>
            @Override
            public void run() {
<span class="nc" id="L627">                LocalDateTime now = LocalDateTime.now();</span>
<span class="nc" id="L628">                long secondsLeft = Duration.between(now, game.getEndTime()).getSeconds();</span>
                
<span class="nc bnc" id="L630" title="All 2 branches missed.">                if (secondsLeft &lt;= 0) {</span>
<span class="nc" id="L631">                    game.setGameStatus(GameStatus.FINISHED);</span>
<span class="nc" id="L632">                    finalizePlayerScores(game);</span>
<span class="nc" id="L633">                    gameRepository.save(game);</span>
<span class="nc" id="L634">                    messagingTemplate.convertAndSend(&quot;/topic/game/&quot; + gameId + &quot;/end&quot;, &quot;Game Over!&quot;);</span>
<span class="nc" id="L635">                    System.out.println(&quot;Game &quot; + gameId + &quot; ended.&quot;);</span>
<span class="nc" id="L636">                    timer.cancel();</span>
                } else {
<span class="nc" id="L638">                    messagingTemplate.convertAndSend(&quot;/topic/game/&quot; + gameId + &quot;/timer&quot;, secondsLeft);</span>
                    // System.out.println(&quot;Time left for game &quot; + gameId + &quot;: &quot; + secondsLeft + &quot; seconds&quot;);                
                }
<span class="nc" id="L641">            }</span>
        };
        
<span class="nc" id="L644">        timer.scheduleAtFixedRate(task, 0, 1000);</span>
<span class="nc" id="L645">        runningTimers.put(gameId, timer);</span>
<span class="nc" id="L646">        messagingTemplate.convertAndSend(&quot;/topic/start/&quot; + gameId + &quot;/scoreboard&quot;, getScoreBoard(gameId));</span>
        
<span class="nc" id="L648">    }</span>
    
    public Map&lt;Country, List&lt;Map&lt;String, Object&gt;&gt;&gt; getHintsOfOneCountry() {
<span class="nc" id="L651">        System.out.println(&quot;hintCache size: &quot; + utilService.getHintCache().size());</span>
<span class="nc" id="L652">        Map&lt;Country, List&lt;Map&lt;String, Object&gt;&gt;&gt; hint = utilService.getHintCache().poll();</span>
<span class="nc bnc" id="L653" title="All 2 branches missed.">        if (utilService.getHintCache().size() &lt; 20) {</span>
<span class="nc" id="L654">            utilService.refillAsync();</span>
        }
<span class="nc" id="L656">        return hint;</span>
    }
    
    public Game saveHintsAndAnswersToGame(Game game, Map&lt;Country, List&lt;Map&lt;String, Object&gt;&gt;&gt; hintSet) {
        
<span class="nc" id="L661">        Long nextQuestionId = game.getHintEntries().stream()</span>
<span class="nc" id="L662">        .mapToLong(HintEntry::getQuestionId)</span>
<span class="nc" id="L663">        .max()</span>
<span class="nc" id="L664">        .orElse(0L) + 1;</span>
        
<span class="nc" id="L666">        Country country = hintSet.keySet().iterator().next();</span>
<span class="nc" id="L667">        List&lt;Map&lt;String, Object&gt;&gt; hints = hintSet.get(country);</span>
        
<span class="nc" id="L669">        List&lt;HintEntry&gt; hintEntries = new ArrayList&lt;&gt;();</span>
        
<span class="nc bnc" id="L671" title="All 2 branches missed.">        for (Map&lt;String, Object&gt; hint : hints) {</span>
<span class="nc" id="L672">            String text = (String) hint.get(&quot;text&quot;);</span>
<span class="nc" id="L673">            Integer difficulty = (Integer) hint.get(&quot;difficulty&quot;);</span>
            
<span class="nc" id="L675">            HintEntry entry = new HintEntry(nextQuestionId, text, difficulty - 1); // Adjust to 0-5 difficulty</span>
<span class="nc" id="L676">            hintEntries.add(entry);</span>
<span class="nc" id="L677">        }</span>
        
<span class="nc" id="L679">        game.getHintEntries().addAll(hintEntries);</span>
<span class="nc" id="L680">        game.getAnswersMap().put(nextQuestionId, country.name());</span>
        
<span class="nc" id="L682">        return game;</span>
    }
    
    public List&lt;PlayerDTO&gt; getScoreBoard(Long gameId) {
<span class="nc" id="L686">        Game game = gameRepository.findById(gameId)</span>
<span class="nc" id="L687">        .orElseThrow(() -&gt; new ResponseStatusException(HttpStatus.NOT_FOUND, &quot;Game not found&quot;));</span>
        
        // if(game.getGameStatus() != GameStatus.ACTIVE || game.getGameStatus() != GameStatus.FINISHED) {
        //     throw new ResponseStatusException(HttpStatus.FORBIDDEN, &quot;Game is neither active nor finished to fetch scoreboard.&quot;);
        // }
<span class="nc" id="L692">        return game.getScoreBoard();</span>
    }
    
    private void finalizePlayerScores(Game game) {
<span class="nc" id="L696">        List&lt;Player&gt; players = game.getPlayers();</span>
        
<span class="nc bnc" id="L698" title="All 2 branches missed.">        for (Player player : players) {</span>
<span class="nc" id="L699">            player.setPlayerStatus(PlayerStatus.FINISHED);</span>
<span class="nc" id="L700">            Long questionId = player.getQuestionId();</span>
<span class="nc bnc" id="L701" title="All 2 branches missed.">            Long correctQuestions = player.getCorrectQuestions() != null ? player.getCorrectQuestions() : 0L;</span>
            
            // Case 1: Player quit immediately, no correct answers
<span class="nc bnc" id="L704" title="All 6 branches missed.">            if (questionId != null &amp;&amp; questionId == 1L &amp;&amp; correctQuestions == 0L) {</span>
<span class="nc" id="L705">                player.setScore(0);</span>
            } 
            // Case 2: Played more than 1 question, deduct unearned points
<span class="nc bnc" id="L708" title="All 4 branches missed.">            else if (questionId != null &amp;&amp; questionId &gt; 1) {</span>
<span class="nc bnc" id="L709" title="All 2 branches missed.">                Integer score = player.getScore() != null ? player.getScore() : 0;</span>
<span class="nc bnc" id="L710" title="All 2 branches missed.">                Integer currentHint = player.getCurrentHint() != null ? player.getCurrentHint() : 0;</span>
                
                // Deduct the unearned part of last question's 100 points
<span class="nc" id="L713">                Integer deduction = 100 - (currentHint * 20);</span>
<span class="nc" id="L714">                player.setScore(Math.max(score - deduction, 0));</span>
            }
            
<span class="nc" id="L717">            playerRepository.save(player);</span>
<span class="nc" id="L718">        }</span>
<span class="nc" id="L719">    }</span>
    
    public List&lt;Player&gt; getPlayersByGameId(Long gameId) {
<span class="nc" id="L722">        Game game = gameRepository.findBygameId(gameId);</span>
        
<span class="nc bnc" id="L724" title="All 2 branches missed.">        if (game == null) {</span>
<span class="nc" id="L725">            throw new ResponseStatusException(HttpStatus.NOT_FOUND, &quot;Game with ID &quot; + gameId + &quot; not found.&quot;);</span>
        }
        
<span class="nc" id="L728">        List&lt;Player&gt; players = playerRepository.findByGame_GameId(gameId);</span>
<span class="nc bnc" id="L729" title="All 4 branches missed.">        if (players == null || players.isEmpty()) {</span>
<span class="nc" id="L730">            throw new ResponseStatusException(HttpStatus.NOT_FOUND, &quot;No players found for game with ID&quot; + gameId);</span>
        }
        // Convert Player entities to PlayerDTOs
<span class="nc" id="L733">        return players;</span>
    }
    
    public HintGetDTO getHint(Long gameId, Long playerId, String token, Integer hintId, Long questionId) {
<span class="nc" id="L737">        Game game = gameRepository.findBygameId(gameId);</span>
<span class="nc bnc" id="L738" title="All 2 branches missed.">        if (game == null) {</span>
<span class="nc" id="L739">            throw new ResponseStatusException(HttpStatus.NOT_FOUND, &quot;Game not found.&quot;);</span>
        }
        
<span class="nc" id="L742">        Player player = playerRepository.findByPlayerId(playerId);</span>
<span class="nc bnc" id="L743" title="All 2 branches missed.">        if (player == null) {</span>
<span class="nc" id="L744">            throw new ResponseStatusException(HttpStatus.NOT_FOUND, &quot;Player not found.&quot;);</span>
        }
        
<span class="nc bnc" id="L747" title="All 2 branches missed.">        if (!player.getToken().equals(token)) {</span>
<span class="nc" id="L748">            throw new ResponseStatusException(HttpStatus.UNAUTHORIZED, &quot;Invalid player token.&quot;);</span>
        }
        
<span class="nc bnc" id="L751" title="All 2 branches missed.">        if (player.getPlayerStatus() != PlayerStatus.PLAYING) {</span>
<span class="nc" id="L752">            throw new ResponseStatusException(HttpStatus.FORBIDDEN, &quot;Player is not playing the game anymore.&quot;);</span>
        }
        
        // validate questionId
<span class="nc" id="L756">        Long currentQuestion = player.getQuestionId();</span>
<span class="nc bnc" id="L757" title="All 2 branches missed.">        if (!questionId.equals(currentQuestion)) {</span>
<span class="nc bnc" id="L758" title="All 2 branches missed.">            if (questionId &lt; currentQuestion) {</span>
<span class="nc" id="L759">                throw new ResponseStatusException(HttpStatus.FORBIDDEN, &quot;Cannot ask for a previously attempted question.&quot;);</span>
            } else {
<span class="nc" id="L761">                throw new ResponseStatusException(HttpStatus.FORBIDDEN, &quot;Cannot ask for a future question.&quot;);</span>
            }
        }
        
<span class="nc" id="L765">        Integer currentHint = player.getCurrentHint();</span>
<span class="nc bnc" id="L766" title="All 6 branches missed.">        if (hintId &gt; currentHint + 1 || hintId &lt; 0 || hintId &gt; game.getMaxHints()) {</span>
<span class="nc" id="L767">            throw new ResponseStatusException(HttpStatus.FORBIDDEN, &quot;Invalid hint request order.&quot;);</span>
        }
        
        // Deduct hint
<span class="nc bnc" id="L771" title="All 2 branches missed.">        if(hintId == currentHint + 1){</span>
<span class="nc" id="L772">            player.useHint();</span>
<span class="nc" id="L773">            player.setScore(player.getScore() - 20);</span>
<span class="nc" id="L774">            player.setCurrentHint(hintId);</span>
<span class="nc" id="L775">            playerRepository.save(player);</span>
        }
        
<span class="nc" id="L778">        HintEntry selectedHint = game.getHintEntries().stream()</span>
<span class="nc" id="L779">        .filter(h -&gt; h.getQuestionId().equals(questionId))</span>
<span class="nc" id="L780">        .filter(h -&gt; h.getDifficulty().equals(hintId))</span>
<span class="nc" id="L781">        .findFirst()</span>
<span class="nc" id="L782">        .orElseThrow(() -&gt; new ResponseStatusException(HttpStatus.NOT_FOUND, &quot;Hint not found&quot;));</span>
        
<span class="nc" id="L784">        HintGetDTO dto = new HintGetDTO();</span>
<span class="nc" id="L785">        dto.setHintText(selectedHint.getText());</span>
        
<span class="nc" id="L787">        messagingTemplate.convertAndSend(&quot;/topic/start/&quot; + gameId + &quot;/scoreboard&quot;, getScoreBoard(gameId));</span>
<span class="nc" id="L788">        System.out.println(getScoreBoard(gameId));</span>
<span class="nc" id="L789">        return dto;</span>
    }
    
    public PlayerResultDTO processingAnswer(Long gameId, Long questionId, Long playerId, String token, Country submittedAnswer) {
        
<span class="nc bnc" id="L794" title="All 4 branches missed.">        if (submittedAnswer == null || !EnumSet.allOf(Country.class).contains(submittedAnswer)) {</span>
<span class="nc" id="L795">            throw new ResponseStatusException(HttpStatus.BAD_REQUEST, &quot;Submitted answer is not a valid country.&quot;);</span>
        }
        
<span class="nc" id="L798">        Game game = gameRepository.findBygameId(gameId);</span>
<span class="nc bnc" id="L799" title="All 2 branches missed.">        if (game == null) {</span>
<span class="nc" id="L800">            throw new ResponseStatusException(HttpStatus.NOT_FOUND, &quot;Game not found.&quot;);</span>
        }
        
<span class="nc" id="L803">        Player player = playerRepository.findByPlayerId(playerId);</span>
<span class="nc bnc" id="L804" title="All 4 branches missed.">        if (player == null || !player.getToken().equals(token)) {</span>
<span class="nc" id="L805">            throw new ResponseStatusException(HttpStatus.UNAUTHORIZED, &quot;Invalid player or token.&quot;);</span>
        }
        
<span class="nc bnc" id="L808" title="All 2 branches missed.">        if (player.getPlayerStatus() != PlayerStatus.PLAYING) {</span>
<span class="nc" id="L809">            throw new ResponseStatusException(HttpStatus.FORBIDDEN, &quot;Player is not playing the game anymore.&quot;);</span>
        }
        
<span class="nc" id="L812">        String correctAnswerStr = game.getAnswersMap().get(questionId);</span>
<span class="nc" id="L813">        Country correctAnswer = Country.valueOf(correctAnswerStr);</span>
<span class="nc" id="L814">        boolean isCorrect = correctAnswer.equals(submittedAnswer);</span>
        
<span class="nc" id="L816">        PlayerResultDTO result = new PlayerResultDTO();</span>
<span class="nc bnc" id="L817" title="All 2 branches missed.">        result.setGuessResult(isCorrect ? GuessResult.CORRECT : GuessResult.INCORRECT);</span>
<span class="nc" id="L818">        player.setTriesLeft(player.getTriesLeft() - 1);</span>
        
<span class="nc bnc" id="L820" title="All 2 branches missed.">        if (isCorrect) {</span>
<span class="nc" id="L821">            player.setScore(player.getScore() + 50); // Award 50 points for correct guess</span>
<span class="nc" id="L822">            player.setCorrectQuestions(player.getCorrectQuestions() + 1);</span>
            
<span class="nc" id="L824">            User user = player.getUser();</span>
<span class="nc bnc" id="L825" title="All 2 branches missed.">            if (user != null) {</span>
                // Get the hint text based on questionId and current hint used
<span class="nc" id="L827">                HintEntry hint = game.getHintEntries().stream()</span>
<span class="nc bnc" id="L828" title="All 2 branches missed.">                .filter(h -&gt; h.getQuestionId().equals(player.getQuestionId()) &amp;&amp;</span>
<span class="nc bnc" id="L829" title="All 2 branches missed.">                h.getDifficulty().equals(player.getCurrentHint()))</span>
<span class="nc" id="L830">                .findFirst()</span>
<span class="nc" id="L831">                .orElse(null);</span>
                
<span class="nc bnc" id="L833" title="All 2 branches missed.">                if (hint != null) {</span>
<span class="nc" id="L834">                    String hintText = hint.getText();</span>
                    
<span class="nc" id="L836">                    boolean alreadyTracked = user.getCountryProgress().stream()</span>
<span class="nc" id="L837">                    .anyMatch(entry -&gt;</span>
<span class="nc bnc" id="L838" title="All 2 branches missed.">                    entry.getCountry().equals(submittedAnswer) &amp;&amp;</span>
<span class="nc bnc" id="L839" title="All 2 branches missed.">                    entry.getInfoLearnt().equals(hintText)</span>
                    );
                    
<span class="nc bnc" id="L842" title="All 2 branches missed.">                    if (!alreadyTracked) {</span>
<span class="nc" id="L843">                        CountryProgressEntry entry = new CountryProgressEntry();</span>
<span class="nc" id="L844">                        entry.setCountry(submittedAnswer);</span>
<span class="nc" id="L845">                        entry.setInfoLearnt(hintText); // Just the hint text</span>
                        
<span class="nc" id="L847">                        user.getCountryProgress().add(entry);</span>
<span class="nc" id="L848">                        userRepository.save(user);</span>
                    }
                }
            }
        }
        
<span class="nc" id="L854">        playerRepository.save(player);</span>
        
<span class="nc bnc" id="L856" title="All 6 branches missed.">        if (isCorrect || player.getHintsLeft() &lt;= 0 || player.getTriesLeft() &lt;= 0) {</span>
<span class="nc" id="L857">            result.setCorrectAnswer(correctAnswer);</span>
<span class="nc" id="L858">            setQuestionStartingScore(playerId);</span>
        }
        
<span class="nc" id="L861">        messagingTemplate.convertAndSend(&quot;/topic/start/&quot; + gameId + &quot;/scoreboard&quot;, getScoreBoard(gameId));</span>
        
<span class="nc" id="L863">        return result;</span>
    }
    
    public void skipQuestion(Long gameId, Long playerId, String token) {
<span class="nc" id="L867">        Game game = gameRepository.findBygameId(gameId);</span>
<span class="nc bnc" id="L868" title="All 2 branches missed.">        if (game == null) {</span>
<span class="nc" id="L869">            throw new ResponseStatusException(HttpStatus.NOT_FOUND, &quot;Game not found.&quot;);</span>
        }
        
<span class="nc" id="L872">        Player player = playerRepository.findByPlayerId(playerId);</span>
<span class="nc bnc" id="L873" title="All 4 branches missed.">        if (player == null || !player.getToken().equals(token)) {</span>
<span class="nc" id="L874">            throw new ResponseStatusException(HttpStatus.UNAUTHORIZED, &quot;Invalid player or token.&quot;);</span>
        }
        
<span class="nc bnc" id="L877" title="All 2 branches missed.">        if (player.getPlayerStatus() != PlayerStatus.PLAYING) {</span>
<span class="nc" id="L878">            throw new ResponseStatusException(HttpStatus.FORBIDDEN, &quot;Player is not playing the game anymore.&quot;);</span>
        }
        
<span class="nc" id="L881">        player.setScore(player.getScore()- (100 - player.getCurrentHint()*20));</span>
<span class="nc" id="L882">        player.setSkippedQuestions(Objects.requireNonNullElse(player.getSkippedQuestions(), 0L) + 1);</span>
<span class="nc" id="L883">        playerRepository.save(player);</span>
<span class="nc" id="L884">        setQuestionStartingScore(playerId);</span>
        
<span class="nc" id="L886">        messagingTemplate.convertAndSend(&quot;/topic/start/&quot; + gameId + &quot;/scoreboard&quot;, getScoreBoard(gameId));</span>
        
<span class="nc" id="L888">    }</span>
    
    public void playerForfiet(Long gameId, Long playerId, String token) {
<span class="nc" id="L891">        Game game = gameRepository.findBygameId(gameId);</span>
<span class="nc bnc" id="L892" title="All 2 branches missed.">        if (game == null) {</span>
<span class="nc" id="L893">            throw new ResponseStatusException(HttpStatus.NOT_FOUND, &quot;Game not found.&quot;);</span>
        }
        
<span class="nc" id="L896">        Player player = playerRepository.findByPlayerId(playerId);</span>
<span class="nc bnc" id="L897" title="All 4 branches missed.">        if (player == null || !player.getToken().equals(token)) {</span>
<span class="nc" id="L898">            throw new ResponseStatusException(HttpStatus.UNAUTHORIZED, &quot;Invalid player or token.&quot;);</span>
        }
        
<span class="nc bnc" id="L901" title="All 2 branches missed.">        if (player.getPlayerStatus() != PlayerStatus.PLAYING) {</span>
<span class="nc" id="L902">            throw new ResponseStatusException(HttpStatus.FORBIDDEN, &quot;Player is not playing the game anymore.&quot;);</span>
        }
<span class="nc" id="L904">        player.setPlayerStatus(PlayerStatus.FINISHED);</span>
<span class="nc" id="L905">        playerRepository.save(player);</span>
        
<span class="nc" id="L907">        messagingTemplate.convertAndSend(&quot;/topic/start/&quot; + gameId + &quot;/scoreboard&quot;, getScoreBoard(gameId));</span>
        
<span class="nc" id="L909">    }</span>
    
    public Object gameResult(Long gameId) {
<span class="nc" id="L912">        Game game = gameRepository.findBygameId(gameId);</span>
<span class="nc bnc" id="L913" title="All 2 branches missed.">        if (game == null) {</span>
<span class="nc" id="L914">            throw new ResponseStatusException(HttpStatus.NOT_FOUND, &quot;Game not found.&quot;);</span>
        }
        
<span class="nc bnc" id="L917" title="All 2 branches missed.">        if(game.getGameStatus() != GameStatus.FINISHED) {</span>
<span class="nc" id="L918">            throw new ResponseStatusException(HttpStatus.FORBIDDEN, &quot;Game is not finished yet.&quot;);</span>
        }
        
<span class="nc" id="L921">        GameMode mode = game.getModeType();</span>
        Object resultDTO;
        
<span class="nc bnc" id="L924" title="All 4 branches missed.">        switch (mode) {</span>
            case SOLO:
<span class="nc" id="L926">            resultDTO = buildSoloResult(game);</span>
<span class="nc" id="L927">            break;</span>
            case ONE_VS_ONE:
<span class="nc" id="L929">            resultDTO = build1v1Result(game);</span>
<span class="nc" id="L930">            break;</span>
            case TEAM_VS_TEAM:
<span class="nc" id="L932">            resultDTO = buildTeamVsTeamResult(game);</span>
<span class="nc" id="L933">            break;</span>
            default:
<span class="nc" id="L935">            throw new IllegalStateException(&quot;Unexpected game mode: &quot; + mode);</span>
        }
        
<span class="nc" id="L938">        messagingTemplate.convertAndSend(&quot;/topic/game/&quot; + gameId + &quot;/end&quot;, resultDTO);</span>
<span class="nc" id="L939">        return resultDTO;</span>
    }
    
    private SoloResultDTO buildSoloResult(Game game) {
<span class="nc" id="L943">        List&lt;PlayerDTO&gt; scoreboard = game.getScoreBoard();</span>
<span class="nc bnc" id="L944" title="All 2 branches missed.">        PlayerDTO player = scoreboard.isEmpty() ? null : scoreboard.get(0);</span>
        
<span class="nc" id="L946">        SoloResultDTO result = new SoloResultDTO();</span>
<span class="nc" id="L947">        result.setPlayer(player);</span>
<span class="nc" id="L948">        result.setScoreboard(scoreboard);</span>
        
<span class="nc" id="L950">        return result;</span>
    }
    
    private OneVsOneResultDTO build1v1Result(Game game) {
<span class="nc" id="L954">        List&lt;PlayerDTO&gt; scoreboard = game.getScoreBoard();</span>
        
<span class="nc bnc" id="L956" title="All 2 branches missed.">        if (scoreboard.size() &lt; 2) {</span>
<span class="nc" id="L957">            throw new IllegalStateException(&quot;Not enough players for 1v1 result&quot;);</span>
        }
        
<span class="nc" id="L960">        PlayerDTO player1 = scoreboard.get(0);</span>
<span class="nc" id="L961">        PlayerDTO player2 = scoreboard.get(1);</span>
        
<span class="nc" id="L963">        OneVsOneResultDTO result = new OneVsOneResultDTO();</span>
<span class="nc" id="L964">        result.setScoreboard(scoreboard);</span>
        
<span class="nc bnc" id="L966" title="All 2 branches missed.">        if (player1.getScore().equals(player2.getScore())) {</span>
            //tie
<span class="nc" id="L968">            result.setWinner(player1);</span>
<span class="nc" id="L969">            result.setLoser(player2);</span>
<span class="nc" id="L970">            result.setDraw(true);</span>
        } else {
<span class="nc" id="L972">            result.setWinner(player1);</span>
<span class="nc" id="L973">            result.setLoser(player2);</span>
<span class="nc" id="L974">            result.setDraw(false);</span>
        }
        
<span class="nc" id="L977">        return result;</span>
    }   
    
    private TeamVsTeamResultDTO buildTeamVsTeamResult(Game game) {
<span class="nc" id="L981">        List&lt;PlayerDTO&gt; scoreboard = game.getScoreBoard();</span>
        
<span class="nc" id="L983">        Map&lt;Long, Integer&gt; teamScores = new HashMap&lt;&gt;();</span>
<span class="nc" id="L984">        Map&lt;Long, String&gt; teamNames = new HashMap&lt;&gt;();</span>
        
<span class="nc bnc" id="L986" title="All 2 branches missed.">        for (PlayerDTO p : scoreboard) {</span>
<span class="nc" id="L987">            Long teamId = p.getTeamId();</span>
<span class="nc bnc" id="L988" title="All 2 branches missed.">            if (teamId == null) continue;</span>
<span class="nc" id="L989">            teamScores.put(teamId, teamScores.getOrDefault(teamId, 0) + p.getScore());</span>
<span class="nc" id="L990">            teamNames.putIfAbsent(teamId, p.getTeamName());</span>
<span class="nc" id="L991">        }</span>
        
<span class="nc bnc" id="L993" title="All 2 branches missed.">        if (teamScores.size() != 2) {</span>
<span class="nc" id="L994">            throw new IllegalStateException(&quot;Expected exactly two teams in TEAM_VS_TEAM mode.&quot;);</span>
        }
        
<span class="nc" id="L997">        List&lt;Map.Entry&lt;Long, Integer&gt;&gt; sortedTeams = new ArrayList&lt;&gt;(teamScores.entrySet());</span>
<span class="nc" id="L998">        sortedTeams.sort((a, b) -&gt; b.getValue().compareTo(a.getValue())); // Descending</span>
        
<span class="nc" id="L1000">        Long winningTeamId = sortedTeams.get(0).getKey();</span>
<span class="nc" id="L1001">        Long losingTeamId = sortedTeams.get(1).getKey();</span>
        
<span class="nc" id="L1003">        TeamVsTeamResultDTO result = new TeamVsTeamResultDTO();</span>
<span class="nc" id="L1004">        result.setWinner(teamNames.get(winningTeamId));</span>
<span class="nc" id="L1005">        result.setLoser(teamNames.get(losingTeamId));</span>
<span class="nc" id="L1006">        result.setTeam1Score(teamScores.get(winningTeamId));</span>
<span class="nc" id="L1007">        result.setTeam2Score(teamScores.get(losingTeamId));</span>
<span class="nc" id="L1008">        result.setScoreboard(scoreboard);</span>
        
<span class="nc bnc" id="L1010" title="All 2 branches missed.">        if (teamScores.get(winningTeamId).equals(teamScores.get(losingTeamId))) {</span>
<span class="nc" id="L1011">            result.setDraw(true);</span>
<span class="nc" id="L1012">            result.setWinner(null);</span>
<span class="nc" id="L1013">            result.setLoser(null);</span>
        } else {
<span class="nc" id="L1015">            result.setDraw(false);</span>
<span class="nc" id="L1016">            result.setWinner(teamNames.get(winningTeamId));</span>
<span class="nc" id="L1017">            result.setLoser(teamNames.get(losingTeamId));</span>
        }
        
<span class="nc" id="L1020">        return result;</span>
    }
    
    
    // public void submitScores(Long gameId,Map&lt;Long, Integer&gt; scoreMap, Map&lt;Long, Integer&gt; correctAnswersMap, Map&lt;Long, Integer&gt; totalQuestionsMap) {
    //     Game game = gameRepository.findBygameId(gameId);
    
    //     if (game == null) {
    //         throw new ResponseStatusException(HttpStatus.NOT_FOUND, &quot;Game not found&quot;);
    //     }
    
    //     // update all users
    //     for (Long userId : scoreMap.keySet()) {
    //         Integer score = scoreMap.get(userId);
    //         Integer correct = correctAnswersMap.getOrDefault(userId, 0);
    //         Integer total = totalQuestionsMap.getOrDefault(userId, 0);
    //         String summary = correct + &quot; of &quot; + total + &quot; correct&quot;;
    
    //         game.updateScore(userId, score);
    //         game.getCorrectAnswersMap().put(userId, correct);
    //         game.getTotalQuestionsMap().put(userId, total);
    //         game.getResultSummaryMap().put(userId, summary);
    
    //     }
    
    //     // end
    //     if (game.getScoreBoard().size() &gt;= game.getCurrentPlayersNumber()) {
    //         game.setEndTime(LocalDateTime.now());
    //         log.info(&quot;Game &quot; + gameId + &quot; ended automatically. All players submitted scores.&quot;);
    //     }
    
    //     gameRepository.save(game);
    // }
    
    // public List&lt;GameGetDTO&gt; getGamesByUser(Long userId) {
    //     User user = userRepository.findById(userId)
    //     .orElseThrow(() -&gt; new ResponseStatusException(HttpStatus.NOT_FOUND));
    //     String username = user.getUsername();
    
    //     return gameRepository.findByPlayersContaining(username).stream()
    //     .filter(game -&gt; game.getEndTime() != null)
    //     .map(game -&gt; {
    //         GameGetDTO dto = DTOMapper.INSTANCE.convertGameEntityToGameGetDTO(game);
    //         dto.setCorrectAnswers(game.getCorrectAnswersMap().get(userId));
    //         dto.setTotalQuestions(game.getTotalQuestionsMap().get(userId));
    //         dto.setResultSummary(game.getResultSummaryMap().get(userId));
    //         return dto;
    //     })
    //     .collect(Collectors.toList());
    // }
    
    //     public List&lt;GameGetDTO&gt; getLeaderboard() {
    //     List&lt;Game&gt; allGames = gameRepository.findAll();
    //     Map&lt;Long, Integer&gt; userScoreMap = new HashMap&lt;&gt;();
    
    //     for (Game game : allGames) {
    //         if (game.getEndTime() == null || game.getScoreBoard() == null) {
    //             continue;
    //         }
    //         for (Map.Entry&lt;Long, Integer&gt; entry : game.getScoreBoard().entrySet()) {
    //             Long userId = entry.getKey();
    //             Integer score = entry.getValue();
    //             userScoreMap.put(userId, userScoreMap.getOrDefault(userId, 0) + score);
    //         }
    //     }
    
    //     List&lt;GameGetDTO&gt; leaderboard = new ArrayList&lt;&gt;();
    //     for (Map.Entry&lt;Long, Integer&gt; entry : userScoreMap.entrySet()) {
    //         Long userId = entry.getKey();
    //         Integer totalScore = entry.getValue();
    
    //         User user = userRepository.findById(userId)
    //         .orElseThrow(() -&gt; new ResponseStatusException(HttpStatus.NOT_FOUND, &quot;User not found&quot;));
    
    //         GameGetDTO dto = new GameGetDTO();
    //         dto.setUserId(userId);
    //         dto.setUsername(user.getUsername());
    //         dto.setTotalScore(totalScore);
    //         leaderboard.add(dto);
    //     }
    
    //     leaderboard.sort((a, b) -&gt; b.getTotalScore().compareTo(a.getTotalScore()));
    
    //     return leaderboard;
    
    // public List&lt;UserHistoryDTO&gt; getUserGameHistory(Long userId) {
    //     User user = userRepository.findById(userId)
    //     .orElseThrow(() -&gt; new ResponseStatusException(HttpStatus.NOT_FOUND));
    
    
    //     return playerRepository.finByUser_UserIdList(userId).stream()
    //     .map(gameId -&gt; gameRepository.findById(gameId).orElse(null))
    //     .filter(Objects::nonNull)
    //     .filter(game -&gt; game.getEndTime() != null)
    //     .map(game -&gt; {
    //         UserHistoryDTO historyDTO = new UserHistoryDTO();
    
    //         GameGetDTO gameDTO = DTOMapper.INSTANCE.convertGameEntityToGameGetDTO(game);
    //         gameDTO.setCorrectAnswers(game.getCorrectAnswersMap().get(userId));
    //         gameDTO.setTotalQuestions(game.getTotalQuestionsMap().get(userId));
    //         gameDTO.setResultSummary(game.getResultSummaryMap().get(userId));
    
    //         List&lt;String&gt; playerUsernames = game.getPlayers().stream()
    //         .map(pid -&gt; userRepository.findByUserId(pid))
    //         .filter(Objects::nonNull)
    //         .map(User::getUsername)
    //         .collect(Collectors.toList());
    
    //         historyDTO.setGame(gameDTO);
    //         historyDTO.setPlayers(playerUsernames);
    //         historyDTO.setCorrectAnswers(game.getCorrectAnswersMap().getOrDefault(userId, 0));
    
    //         return historyDTO;
    //     })
    //     .collect(Collectors.toList());
    // }
    
    
    // }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>