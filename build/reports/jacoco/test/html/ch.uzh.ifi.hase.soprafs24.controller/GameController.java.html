<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GameController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sopra-fs25-group-10-server</a> &gt; <a href="index.source.html" class="el_package">ch.uzh.ifi.hase.soprafs24.controller</a> &gt; <span class="el_source">GameController.java</span></div><h1>GameController.java</h1><pre class="source lang-java linenums">package ch.uzh.ifi.hase.soprafs24.controller;


import ch.uzh.ifi.hase.soprafs24.constant.GameMode;
import ch.uzh.ifi.hase.soprafs24.entity.Game;
import ch.uzh.ifi.hase.soprafs24.entity.Player;
import ch.uzh.ifi.hase.soprafs24.entity.User;
import ch.uzh.ifi.hase.soprafs24.rest.dto.GameCreateResponseDTO;
import ch.uzh.ifi.hase.soprafs24.rest.dto.GameGetDTO;
import ch.uzh.ifi.hase.soprafs24.rest.dto.LobbyJoinGetDTO;
import ch.uzh.ifi.hase.soprafs24.rest.dto.LobbyJoinPostDTO;
import ch.uzh.ifi.hase.soprafs24.rest.dto.PlayerAnswerDTO;
import ch.uzh.ifi.hase.soprafs24.rest.dto.PlayerAuthDTO;
import ch.uzh.ifi.hase.soprafs24.rest.dto.PlayerDTO;
import ch.uzh.ifi.hase.soprafs24.rest.dto.PlayerResultDTO;
import ch.uzh.ifi.hase.soprafs24.rest.dto.PlayerSimpleDTO;
import ch.uzh.ifi.hase.soprafs24.rest.dto.GamePostDTO;
import ch.uzh.ifi.hase.soprafs24.rest.dto.GameStartDTO;
import ch.uzh.ifi.hase.soprafs24.rest.dto.HintGetDTO;
import ch.uzh.ifi.hase.soprafs24.rest.dto.HintPostDTO;
import ch.uzh.ifi.hase.soprafs24.rest.dto.UserGetDTO;
import ch.uzh.ifi.hase.soprafs24.rest.dto.UserPostDTO;
import ch.uzh.ifi.hase.soprafs24.rest.mapper.DTOMapper;
import ch.uzh.ifi.hase.soprafs24.service.GameService;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.messaging.simp.SimpMessagingTemplate;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.server.ResponseStatusException;

import java.util.ArrayList;
import java.util.Map;
import java.util.List;
import java.util.stream.Collectors;


/**
* User Controller
* This class is responsible for handling all REST request that are related to
* the user.
* The controller will receive the request and delegate the execution to the
* UserService and finally return the result.
*/

@RestController
public class GameController {
    
    private final GameService gameService;
    
    @Autowired
    private SimpMessagingTemplate messagingTemplate;
    
<span class="nc" id="L55">    GameController(GameService gameService) {</span>
<span class="nc" id="L56">        this.gameService = gameService;</span>
<span class="nc" id="L57">    }</span>
    
    @PostMapping(&quot;/games&quot;)
    @ResponseStatus(HttpStatus.CREATED)
    @ResponseBody
    public GameCreateResponseDTO createGame(@RequestBody GamePostDTO gamePostDTO) {
<span class="nc" id="L63">        Game gameToCreate = DTOMapper.INSTANCE.convertGamePostDTOtoGameEntity(gamePostDTO);</span>
<span class="nc" id="L64">        return gameService.createGame(gameToCreate);</span>
    }
    
    @GetMapping(&quot;/lobby&quot;)
    @ResponseStatus(HttpStatus.OK)
    @ResponseBody
    public List&lt;GameGetDTO&gt; getGameLobby() {
<span class="nc" id="L71">        List&lt;Game&gt; allGames = gameService.getAllGames();</span>
        
<span class="nc" id="L73">        List&lt;GameGetDTO&gt; gameLobbyGetDTOs = allGames.stream()</span>
<span class="nc bnc" id="L74" title="All 4 branches missed.">        .filter(game -&gt; game.getModeType() == GameMode.ONE_VS_ONE || game.getModeType() == GameMode.TEAM_VS_TEAM)</span>
<span class="nc" id="L75">        .map(DTOMapper.INSTANCE::convertGameEntityToGameGetDTO)</span>
<span class="nc" id="L76">        .collect(Collectors.toList());</span>
        
<span class="nc" id="L78">        return gameLobbyGetDTOs;</span>
    }
    
    
    @GetMapping(&quot;/game/{gameId}&quot;)
    @ResponseStatus(HttpStatus.OK)
    @ResponseBody
    public GameGetDTO getGameReady(@PathVariable Long gameId) {
<span class="nc" id="L86">        Game gameSelected = gameService.getGameByGameId(gameId);</span>
<span class="nc bnc" id="L87" title="All 2 branches missed.">        if (gameSelected == null) {</span>
<span class="nc" id="L88">            throw new ResponseStatusException(HttpStatus.NOT_FOUND, &quot;Game not found&quot;);</span>
        }
<span class="nc" id="L90">        return DTOMapper.INSTANCE.convertGameEntityToGameGetDTO(gameSelected);</span>
    }
    
    @PostMapping(&quot;/lobby/{gameId}/join&quot;)
    @ResponseStatus(HttpStatus.OK)
    @ResponseBody
    public PlayerAuthDTO joinGame(@PathVariable Long gameId,
    @RequestBody(required = false) LobbyJoinPostDTO joinDTO) {
<span class="nc bnc" id="L98" title="All 2 branches missed.">        Long userId = joinDTO != null ? joinDTO.getUserId() : null;</span>
<span class="nc bnc" id="L99" title="All 2 branches missed.">        String password = joinDTO != null ? joinDTO.getPassword() : null;</span>
        
<span class="nc" id="L101">        return DTOMapper.INSTANCE.convertPlayerToPlayerAuthDTO(gameService.userJoinGame(gameId, userId, password));</span>
    }
    
    @PutMapping(&quot;/lobbyOut/{playerId}&quot;)
    @ResponseStatus(HttpStatus.OK)
    @ResponseBody
    public void exitGame(@PathVariable Long playerId) {
<span class="nc" id="L108">        gameService.playerExitGame(playerId);</span>
<span class="nc" id="L109">    }</span>
    
    //   @GetMapping(&quot;/ready/{gameId}&quot;)
    //   @ResponseStatus(HttpStatus.OK)
    //   @ResponseBody
    //   public List&lt;UserGetDTO&gt; getGamePlayers(@PathVariable Long gameId) {
    //     List&lt;User&gt; players = gameService.getGamePlayers(gameId);
    
    //     List&lt;UserGetDTO&gt; allPlayersDTOs = new ArrayList&lt;&gt;();
    //     for (User player : players) {
    //       allPlayersDTOs.add(DTOMapper.INSTANCE.convertEntityToUserGetDTO(player));
    //     }
    //     return allPlayersDTOs;
    //   }
    
    @PutMapping(&quot;/start/{gameId}&quot;)
    @ResponseStatus(HttpStatus.OK)
    public void startGame(@PathVariable Long gameId, @RequestBody  GameStartDTO player) {
<span class="nc" id="L127">        gameService.startGame(gameId, player);</span>
<span class="nc" id="L128">    }</span>
    
    // @PutMapping(&quot;/games/{gameId}/end&quot;)
    // @ResponseStatus(HttpStatus.NO_CONTENT)
    // public void submitScores(@PathVariable Long gameId, @RequestBody GamePostDTO gamePostDTO) {
    //     gameService.submitScores(
    //     gameId,
    //     gamePostDTO.getScoreMap(),
    //     gamePostDTO.getCorrectAnswersMap(),
    //     gamePostDTO.getTotalQuestionsMap()
    //     );
    // }
    
    @PutMapping(&quot;/game/{gameId}/end&quot;)
    @ResponseStatus(HttpStatus.NO_CONTENT)
    public void playerForfiet(@PathVariable Long gameId, @RequestBody PlayerSimpleDTO playerDTO) {
<span class="nc" id="L144">        gameService.playerForfiet(</span>
        gameId,
<span class="nc" id="L146">        playerDTO.getPlayerId(),</span>
<span class="nc" id="L147">        playerDTO.getToken()</span>
        );
<span class="nc" id="L149">    }</span>
    
    
    // @GetMapping(&quot;/users/{userId}/history&quot;)
    // @ResponseStatus(HttpStatus.OK)
    // @ResponseBody
    // public List&lt;GameGetDTO&gt; getUserGameHistory(@PathVariable Long userId) {
    //     return gameService.getGamesByUser(userId);
    // }
    
    @GetMapping(&quot;/game/{gameId}/scoreBoard&quot;)
    @ResponseStatus(HttpStatus.OK)
    @ResponseBody
    public List&lt;PlayerDTO&gt; getScoreboard(@PathVariable Long gameId) {
<span class="nc" id="L163">        return gameService.getScoreBoard(gameId);</span>
    }
    
    // @GetMapping(&quot;/leaderboard&quot;)
    // @ResponseStatus(HttpStatus.OK)
    // @ResponseBody
    // public List&lt;GameGetDTO&gt; getLeaderboard() {
    //     return gameService.getLeaderboard();
    // }
    
    @PostMapping(&quot;/game/{gameId}/{questionId}/hint/{hintId}&quot;)
    public HintGetDTO getHintForPlayer(
    @PathVariable Long gameId,
    @PathVariable Long questionId,
    @PathVariable Integer hintId,
    @RequestBody HintPostDTO hintPostDTO
    ) {
<span class="nc" id="L180">        return gameService.getHint( gameId,</span>
<span class="nc" id="L181">        hintPostDTO.getPlayerId(),</span>
<span class="nc" id="L182">        hintPostDTO.getToken(),</span>
        hintId,
        questionId
        );
    }
    
    
    
    @PostMapping(&quot;/game/{gameId}/{questionId}/answer&quot;)
    @ResponseStatus(HttpStatus.OK)
    @ResponseBody
    public PlayerResultDTO answerProcessing(@PathVariable Long questionId,
    @PathVariable Long gameId,
    @RequestBody PlayerAnswerDTO playerAnswerDTO){
<span class="nc" id="L196">        return gameService.processingAnswer(gameId,</span>
        questionId,
<span class="nc" id="L198">        playerAnswerDTO.getPlayerId(),</span>
<span class="nc" id="L199">        playerAnswerDTO.getToken(),</span>
<span class="nc" id="L200">        playerAnswerDTO.getAnswer());</span>
    }
    
    
    @PostMapping(&quot;/game/{gameId}/{questionId}/skip&quot;)
    @ResponseStatus(HttpStatus.OK)
    @ResponseBody
    public void skipQuestion(@PathVariable Long questionId,
    @PathVariable Long gameId,
    @RequestBody PlayerSimpleDTO playerDTO){
<span class="nc" id="L210">        gameService.skipQuestion(gameId, playerDTO.getPlayerId(), playerDTO.getToken());</span>
<span class="nc" id="L211">    }</span>
    
    @GetMapping(&quot;/game/{gameId}/result&quot;)
    @ResponseStatus(HttpStatus.OK)
    @ResponseBody
    public Object getGameResult(@PathVariable Long gameId) {
<span class="nc" id="L217">        return gameService.gameResult(gameId);</span>
    }
    
    // @PutMapping(&quot;/giveup/{userId}&quot;)
    // @ResponseStatus(HttpStatus.OK)
    // @ResponseBody
    // public void giveupGame(@PathVariable Long userId){
    //     gameService.giveupGame(userId);
    // }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>